#!/usr/bin/php -q
<?php
function users($ip) {
  mysql_connect("91.223.48.25","root","");
  $query="select * from dv_logs where CID like '%$ip%' order by start desc";
  $res=mysql("abills",$query);
  $num=mysql_num_rows($res);
  if ($num > 0 ) {
    $user=mysql_result($res,0,"uid");
  }
  
  
}

function address($user,$sdate) {
$query="select username,count(*) as enter from sessions where mvsip like '$user' and dateStart > date_sub(now(),interval 1 month) group by username order by enter desc";
// echo $query;
$res=mysql("sky_switch",$query);
$num=mysql_num_rows($res);
if ($num) {
  for ($i=0;$i<$num;$i++) {
    $users=mysql_result($res,0,"username");
    $access=mysql_result($res,0,"enter");
    $query="select * from customers where username like '$users'";
    $resa=mysql("sky_switch",$query);
    $address=mysql_result($resa,0,"address");
    $s=" $users ($access) $address";
    return($s);
  }
} else {
  return;
}
}
// include("/usr/local/apache/servers/statmvs.mariupol.net/include/connect.inc");
mysql_connect("localhost","root","zabbix");
// $cmd="/usr/local/bin/snmpwalk -v 1 -c public -On 195.72.157.250 1.3.6.1.2.1.17.7.1.2.2.1.2";
 $cmd="/usr/bin/snmpwalk -v 1 -c 1XyJfhQM2rPLlXuj -O n 91.223.48.1 .1.3.6.1.2.1.3.1.1.2";
// echo $cmd;
$pp=popen($cmd,"r");
while (!feof($pp)) {
  $str=trim(fgets($pp,1024));
  if (strlen($str) > 2 ) {
  
//  echo $str."\n";
  $str=ereg_replace(".1.3.6.1.2.1.3.1.1.2.","",$str);
//  echo $str."\n";
//  preg_match("/.1.3.6.1.2.1.17.7.1.2.2.1.2.([\d]+).([\d]+).([\d]+).([\d]+).([\d]+).([\d]+).([\d]+) = INTEGER: ([\d]+)/",$str,$mem,PREG_OFFSET_CAPTURE,0);
  preg_match("/([\d]+).([\d]+).([\d]+).([\d]+).([\d]+).([\d]+) = Hex-STRING: ([\d\w]+) ([\d\w]+) ([\d\w]+) ([\d\w]+) ([\d\w]+) ([\d\w]+)/",$str,$mem,PREG_OFFSET_CAPTURE,0);
//  var_dump($mem);
  $ips=$mem[3][0].".".$mem[4][0].".".$mem[5][0].".".$mem[6][0];
  $mac1=sprintf("%s",strtolower($mem[7][0]));
  if (strlen($mac1) == 1) { 
    $s1="0".$mac1;
    $mac1=$s1;
  }
  $mac2=sprintf("%+02s",strtolower($mem[8][0]));
  if (strlen($mac2) == 1) { 
    $s1="0".$mac2;
    $mac2=$s1;
  }
  $mac3=sprintf("%+02s",strtolower($mem[9][0]));
  if (strlen($mac3) == 1) { 
    $s1="0".$mac3;
    $mac3=$s1;
  }
  $mac4=sprintf("%+02s",strtolower($mem[10][0]));
  if (strlen($mac4) == 1) { 
    $s1="0".$mac4;
    $mac4=$s1;
  }
  $mac5=sprintf("%+02s",strtolower($mem[11][0]));
  if (strlen($mac5) == 1) { 
    $s1="0".$mac5;
    $mac5=$s1;
  }
  $mac6=sprintf("%+02s",strtolower($mem[12][0]));
  if (strlen($mac6) == 1) { 
    $s1="0".$mac6;
    $mac6=$s1;
  }

  $mac="$mac1:$mac2:$mac3:$mac4:$mac5:$mac6";
//  $mac=dechex($mem[2][0]).":".dechex($mem[3][0]).":".dechex($mem[4][0]).":".dechex($mem[5][0]).":".dechex($mem[6][0]).":".dechex($mem[7][0]);
  $port=$mem[1][0];
  $query="insert into ipmac(ip,mac,cdate,fdate,switch,port) VALUES('$ips','$mac',now(),now(),'91.223.48.1','$port')";
  $res=mysql("sky_switch",$query);
  $err=mysql_error();
//  echo "$query\n";
//  echo $err;
  if (!empty($err)) {
    $query="update ipmac set cdate=now() where mac like '$mac' and ip like '$ips' and switch like '195.72.157.250' and port like '$port'";
    $res=mysql("sky_switch",$query);
//    echo "update";
  } else {
//    echo "not update";  
  }
/*
  $query="select * from ip where mac like '$mac'";
  $res=mysql("mvs",$query);
  $num=mysql_num_rows($res);
  if ($num > 0) {
    $ip=mysql_result($res,0,"ip");
    $addr=address($ip,"");
  } else {
    $ip="";
    $addr="";
  }
*/
//  echo "$port ($ip): $mac $addr\n";
//  if (!empty($addr))  
  $addr="";
  echo "$ips ($port): $mac $addr\n";
  }
//  exit;
}

?>